/*! ramp-theme-usability 23-01-2015 18:47:30 : v. 5.0.0-10 
 * 
 * RAMP GIS viewer - Elk; Sample of an implementation of RAMP with Usability Theme 
 **/
define(["dojo/topic","dojo/_base/array","esri/layers/GraphicsLayer","esri/tasks/GeometryService","esri/tasks/ProjectParameters","esri/geometry/Extent","ramp/eventManager","ramp/map","ramp/globalStorage","ramp/featureClickHandler","ramp/mapClickHandler","ramp/ramp","ramp/filterManager","ramp/layerItem","utils/util"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";function p(a,b,c){if(c){var d;if(d=m.getLayerState(a),d===n.state.ERROR)return}m.setLayerState(a,b)}function q(a,b){var g,l,q,r=h.getMap(),s=a.ramp.config;switch(!a.ramp,a.ramp.type){case i.layerType.wms:l=i.layerType.wms,o.isUndefined(b)?(g=RAMP.layerCounts.base+RAMP.layerCounts.wms,RAMP.layerCounts.wms+=1,s.legendMimeType&&(a.ramp.config.legend={type:"wms",imageUrl:String.format("{0}?SERVICE=WMS&REQUEST=GetLegendGraphic&TRANSPARENT=true&VERSION=1.1.1&FORMAT={2}&LAYER={3}",s.url,a.version,s.legendMimeType,s.layerName)})):g=b;break;case i.layerType.feature:case i.layerType.Static:l=i.layerType.feature,o.isUndefined(b)?(g=RAMP.layerCounts.feature,RAMP.layerCounts.feature+=1):g=b}switch(a.ramp.load.state){case"loaded":q=n.state.LOADED;break;case"loading":q=n.state.LOADING;break;case"error":q=n.state.ERROR}switch(o.isUndefined(b)?m.addLayer(l,a.ramp.config,q):p(s.id,q),a.ramp.load.inLS=!0,RAMP.layerRegistry[a.id]=a,r.addLayer(a,g),a.ramp.type){case i.layerType.wms:o.isUndefined(s.featureInfo)||k.registerWMSClick({wmsLayer:a,layerConfig:s});break;case i.layerType.feature:if(a.on("click",function(a){a.stopImmediatePropagation(),j.onFeatureSelect(a)}),a.on("mouse-over",function(a){j.onFeatureMouseOver(a)}),a.on("mouse-out",function(a){j.onFeatureMouseOut(a)}),o.isUndefined(b)){var t,u=new c({id:String.format("boundingBoxLayer_{0}",a.id),visible:s.settings.boundingBoxVisible});if(u.ramp={type:i.layerType.BoundingBox},!o.isUndefined(s.layerExtent))if(t=new f(s.layerExtent),o.isSpatialRefEqual(t.spatialReference,r.spatialReference))u.add(o.createGraphic(t));else{var v=new e,w=new d(RAMP.config.geometryServiceUrl);v.geometries=[t],v.outSR=r.spatialReference,w.project(v,function(a){u.add(o.createGraphic(a[0]))})}h.getBoundingBoxMapping()[a.id]=u,g=RAMP.layerCounts.feature+RAMP.layerCounts.bb,RAMP.layerCounts.bb+=1,r.addLayer(u,g)}}}return{init:function(){RAMP.layerCounts={feature:0,bb:0,wms:0,base:1},RAMP.layerRegistry={},a.subscribe(g.LayerLoader.LAYER_LOADED,this.onLayerLoaded),a.subscribe(g.LayerLoader.LAYER_UPDATED,this.onLayerUpdateEnd),a.subscribe(g.LayerLoader.LAYER_UPDATING,this.onLayerUpdateStart),a.subscribe(g.LayerLoader.LAYER_ERROR,this.onLayerError),a.subscribe(g.LayerLoader.REMOVE_LAYER,this.onLayerRemove),a.subscribe(g.LayerLoader.RELOAD_LAYER,this.onLayerReload)},onLayerError:function(a){a.layer.ramp.load.state="error",a.layer.ramp.load.inLS&&p(a.layer.ramp.config.id,n.state.ERROR,!1)},onLayerUpdateStart:function(a){p(a.layer.ramp.config.id,n.state.UPDATING,!0)},onLayerUpdateEnd:function(a){p(a.layer.ramp.config.id,n.state.LOADED,!0)},onLayerLoaded:function(a){a.layer.ramp.load.state="loaded",a.layer.ramp.load.inLS&&p(a.layer.ramp.config.id,n.state.LOADED,!0)},onLayerRemove:function(a){var b,c,d,e,f,g,j=h.getMap();switch(c=h.getBoundingBoxMapping()[a.layerId],b=j._layers[a.layerId],b?g=!0:(g=!1,b=RAMP.layerRegistry[a.layerId]),b.ramp.type){case i.layerType.wms:e=i.layerType.wms,f=RAMP.config.layers.wms,RAMP.layerCounts.wms-=1;break;case i.layerType.feature:case i.layerType.Static:e=i.layerType.feature,f=RAMP.config.layers.feature,RAMP.layerCounts.feature-=1}m.removeLayer(e,a.layerId),g&&j.removeLayer(b),c&&j.removeLayer(c),d=f.indexOf(b.ramp.config),f.splice(d,1),RAMP.layerRegistry[a.layerId]=void 0},onLayerReload:function(a){var c,d,e,f,g,j,k,l,m=h.getMap();switch(c=m._layers[a.layerId],c?j=!0:(j=!1,c=RAMP.layerRegistry[a.layerId]),d=c.ramp.config,e=c.ramp.user,k=$("#"+RAMP.config.divNames.filter).find("#layerList").find("> li > ul"),l=k.map(function(a,b){return $(b).find("> li").toArray().reverse()}).map(function(a,b){return b.id}),g=b.indexOf(l,a.layerId),c.ramp.type===i.layerType.wms&&(g=g+RAMP.layerCounts.base-RAMP.layerCounts.feature),j&&m.removeLayer(c),c.ramp.type){case i.layerType.wms:f=h.makeWmsLayer(d,e);break;case i.layerType.feature:f=h.makeFeatureLayer(d,e);break;case i.layerType.Static:f=h.makeStaticLayer(d,e)}q(f,g)},loadLayer:function(a,b){q(a,b)}}});
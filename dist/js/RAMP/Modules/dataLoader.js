/*! ramp-theme-usability 30-01-2015 15:45:30 : v. 5.0.0-8 
 * 
 * RAMP GIS viewer - Elk; Sample of an implementation of RAMP with Usability Theme 
 **/
define(["dojo/Deferred","esri/request","esri/SpatialReference","esri/layers/FeatureLayer","utils/util","dojo/_base/array"],function(a,b,c,d,e,f){"use strict";function g(c){var d,f=new a;if(c.file){if(c.url)throw new Error("Either url or file should be specified, not both");d="binary"===c.type?e.readFileAsArrayBuffer(c.file):e.readFileAsText(c.file)}else{if(!c.url)throw new Error("One of url or file should be specified");try{d=new b({url:c.url,handleAs:"text"}).promise}catch(g){f.reject(g)}}return d.then(function(a){f.resolve(a)},function(a){f.reject(a)}),f.promise}function h(a){if("FeatureCollection"!==a.type)throw new Error("Assignment can only be performed on FeatureCollections");f.forEach(a.features,function(a,b){"undefined"==typeof a.id&&(a.id=b)})}function i(a,b){var e,f,g,i,j,k;return f={objectIdField:"OBJECTID",fields:[{name:"OBJECTID",type:"esriFieldTypeOID"}]},j=RAMP.map.spatialReference.wkid,h(a),f.drawingInfo=m[n[a.features[0].geometry.type]],b&&(b.renderer&&m.hasOwnProperty(b.renderer)&&(f.drawingInfo={renderer:m[b.renderer].renderer},i.geometryType=m[b.renderer].geometryType),b.sourceProjection&&(k=b.sourceProjection),b.targetWkid&&(j=b.targetWkid),b.fields&&(f.fields=f.fields.concat(b.fields))),Terraformer.Proj.convert(a,"EPSG:"+j,k),e=Terraformer.ArcGIS.convert(a,{sr:j}),i={features:e,geometryType:f.drawingInfo.geometryType},g=new d({layerDefinition:f,featureSet:i},{mode:d.MODE_SNAPSHOT}),g.spatialReference=new c({wkid:j}),g.ramp={type:"newtype?"},g}function j(b,c){var d=new a,e={latfield:"Lat",lonfield:"Long",delimiter:","};c&&(c.latfield&&(e.latfield=c.latfield),c.lonfield&&(e.lonfield=c.lonfield),c.delimiter&&(e.delimiter=c.delimiter));try{csv2geojson.csv2geojson(b,e,function(a,b){var c;return a?void d.reject(a):(c=i(b),void d.resolve(c))})}catch(f){d.reject(f)}return d.promise}function k(b){var c=new a;try{shp(b).then(function(a){var b;try{b=i(a),c.resolve(b)}catch(d){c.reject(d)}},function(a){c.reject(a)})}catch(d){c.reject(d)}return c.promise}function l(b){var c=new a,d=null;try{d=i(JSON.parse(b)),c.resolve(d)}catch(e){c.reject(e)}return c.promise}var m={circlePoint:{geometryType:"esriGeometryPoint",renderer:{type:"simple",symbol:{type:"esriSMS",style:"esriSMSCircle",color:[67,100,255,200],size:7}}},solidLine:{geometryType:"esriGeometryPolyline",renderer:{type:"simple",symbol:{type:"esriSLS",style:"esriSLSSolid",color:[90,90,90,200],width:2}}},outlinedPoly:{geometryType:"esriGeometryPolygon",renderer:{type:"simple",symbol:{type:"esriSFS",style:"esriSFSSolid",color:[76,76,125,200],outline:{type:"esriSLS",style:"esriSLSSolid",color:[110,110,110,255],width:1}}}}},n={Point:"circlePoint",MultiPoint:"circlePoint",LineString:"solidLine",MultiLineString:"solidLine",Polygon:"outlinedPoly",MultiPolygon:"outlinedPoly"};return{loadDataSet:g,makeGeoJsonLayer:i,buildCsv:j,buildShapefile:k,buildGeoJson:l}});
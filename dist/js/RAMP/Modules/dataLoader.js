/*! ramp-theme-intranet 06-02-2015 15:33:30 : v. 5.0.0-9 
 * 
 * RAMP GIS viewer - Elk; Sample of an implementation of RAMP with Intranet Theme 
 **/
define(["dojo/Deferred","dojo/query","esri/request","esri/SpatialReference","esri/layers/FeatureLayer","ramp/layerLoader","utils/util","dojo/_base/array"],function(a,b,c,d,e,f,g,h){"use strict";function i(b){var d,e=new a;if(b.file){if(b.url)throw new Error("Either url or file should be specified, not both");d="binary"===b.type?g.readFileAsArrayBuffer(b.file):g.readFileAsText(b.file)}else{if(!b.url)throw new Error("One of url or file should be specified");try{d=new c({url:b.url,handleAs:"text"}).promise}catch(f){e.reject(f)}}return d.then(function(a){e.resolve(a)},function(a){e.reject(a)}),e.promise}function j(b){var d,e=new a;try{d=new c({url:b+"?f=json"}).promise}catch(f){e.reject(f)}return d.then(function(a){var c={layerId:a.id,layerName:a.name,layerUrl:b,geometryType:a.geometryType,fields:h.map(a.fields,function(a){return a.name})};e.resolve(c)},function(a){e.reject(a)}),e.promise}function k(d){function e(a,b){var c;for(c=0;c<a.childNodes.length;++c)if(a.childNodes[c].nodeName===b)return a.childNodes[c];return void 0}var f,g=new a;try{f=new c({url:d+"?service=WMS&version=1.3&request=GetCapabilities",handleAs:"xml"}).promise}catch(i){g.reject(i)}return f.then(function(a){var c,d={};try{c=h.map(b("Layer > Name",a),function(a){return a.parentNode}),d.layers=h.map(c,function(a){var b=e(a,"Name").textContent,c=e(a,"Title");return{name:b,desc:c?c.textContent:b,queryable:"1"===a.getAttribute("queryable")}}),d.queryTypes=h.map(b("GetFeatureInfo > Format",a),function(a){return a.textContent})}catch(f){g.reject(f)}g.resolve(d)},function(a){g.reject(a)}),g.promise}function l(a){if("FeatureCollection"!==a.type)throw new Error("Assignment can only be performed on FeatureCollections");h.forEach(a.features,function(a,b){"undefined"==typeof a.id&&(a.id=b)})}function m(a,b){var c,f,g,h,i,j;return f={objectIdField:"OBJECTID",fields:[{name:"OBJECTID",type:"esriFieldTypeOID"}]},i=RAMP.map.spatialReference.wkid,l(a),f.drawingInfo=q[r[a.features[0].geometry.type]],b&&(b.renderer&&q.hasOwnProperty(b.renderer)&&(f.drawingInfo={renderer:q[b.renderer].renderer},h.geometryType=q[b.renderer].geometryType),b.sourceProjection&&(j=b.sourceProjection),b.targetWkid&&(i=b.targetWkid),b.fields&&(f.fields=f.fields.concat(b.fields))),Terraformer.Proj.convert(a,"EPSG:"+i,j),c=Terraformer.ArcGIS.convert(a,{sr:i}),h={features:c,geometryType:f.drawingInfo.geometryType},g=new e({layerDefinition:f,featureSet:h},{mode:e.MODE_SNAPSHOT}),g.spatialReference=new d({wkid:i}),g.ramp={type:"newtype?"},g}function n(b,c){var d=new a,e={latfield:"Lat",lonfield:"Long",delimiter:","};c&&(c.latfield&&(e.latfield=c.latfield),c.lonfield&&(e.lonfield=c.lonfield),c.delimiter&&(e.delimiter=c.delimiter));try{csv2geojson.csv2geojson(b,e,function(a,b){var c;return a?void d.reject(a):(c=m(b),void d.resolve(c))})}catch(f){d.reject(f)}return d.promise}function o(b){var c=new a;try{shp(b).then(function(a){var b;try{b=m(a),c.resolve(b)}catch(d){c.reject(d)}},function(a){c.reject(a)})}catch(d){c.reject(d)}return c.promise}function p(b){var c=new a,d=null;try{d=m(JSON.parse(b)),c.resolve(d)}catch(e){c.reject(e)}return c.promise}var q={circlePoint:{geometryType:"esriGeometryPoint",renderer:{type:"simple",symbol:{type:"esriSMS",style:"esriSMSCircle",color:[67,100,255,200],size:7}}},solidLine:{geometryType:"esriGeometryPolyline",renderer:{type:"simple",symbol:{type:"esriSLS",style:"esriSLSSolid",color:[90,90,90,200],width:2}}},outlinedPoly:{geometryType:"esriGeometryPolygon",renderer:{type:"simple",symbol:{type:"esriSFS",style:"esriSFSSolid",color:[76,76,125,200],outline:{type:"esriSLS",style:"esriSLSSolid",color:[110,110,110,255],width:1}}}}},r={Point:"circlePoint",MultiPoint:"circlePoint",LineString:"solidLine",MultiLineString:"solidLine",Polygon:"outlinedPoly",MultiPolygon:"outlinedPoly"};return{loadDataSet:i,getFeatureLayer:j,getWmsLayerList:k,makeGeoJsonLayer:m,buildCsv:n,buildShapefile:o,buildGeoJson:p}});